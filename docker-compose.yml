services:
  vikunja:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - SERVICE_FQDN_VIKUNJA
      - SERVICE_PASSWORD_JWTSECRET
      - SERVICE_PASSWORD_POSTGRESQL
      - 'TIMEZONE=${TIMEZONE-CA}'
      - TYPESENSE_APIKEY
      - 'SMTP_HOST=${SMTP_HOST-smtp.smtp2go.com}'
      - 'SMTP_PORT=${SMTP_PORT-2525}'
      - SMTP_USER
      - SMTP_PASSWORD
      - 'SMTP_AUTHTYPE=${SMTP_AUTHTYPE-plain}'
      - 'SMTP_FROMEMAIL=${SMTP_FROMEMAIL-vikunja@mail.aquati.cat}'
      - TODOIST_CLIENTID
      - TODOIST_CLIENTSECRET
      - 'METRICS_USERNAME=${METRICS_USERNAME-user}'
      - METRICS_PASSWORD
    volumes:
      - 'vikunja-data:/opt/vikunja/'
    ports:
      - '3456:3456'
    depends_on:
      postgresql:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3456']
        
  postgresql:
    image: 'postgres:latest'
    volumes:
      - 'postgresql-data:/var/lib/postgresql/data'
    environment:
      - 'POSTGRES_USER=vikunja'
      - 'POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRESQL}'
      - 'POSTGRES_DB=vikunja'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}']
      
  typesense:
    image: typesense/typesense:29.0
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8108/health']
    environment:
      - 'TYPESENSE_API_KEY=${TYPESENSE_APIKEY}'
    ports:
      - "8108:8108"
    volumes:
      - 'typesense-data:/data'
   
volumes:
  vikunja-data:
  postgresql-data:
  typesense-data:
